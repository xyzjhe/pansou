# PanSou æ’ä»¶å¼€å‘æŒ‡å—

## æ¦‚è¿°

PanSou é‡‡ç”¨å¼‚æ­¥æ’ä»¶æ¶æ„ï¼Œæ”¯æŒé€šè¿‡æ’ä»¶æ‰©å±•æœç´¢æ¥æºã€‚æ’ä»¶ç³»ç»ŸåŸºäº Go æ¥å£è®¾è®¡ï¼Œæä¾›é«˜æ€§èƒ½çš„å¹¶å‘æœç´¢èƒ½åŠ›å’Œæ™ºèƒ½ç¼“å­˜æœºåˆ¶ã€‚

## ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

- **æ’ä»¶ç®¡ç†å™¨ (PluginManager)**: ç®¡ç†æ‰€æœ‰æ’ä»¶çš„æ³¨å†Œå’Œè°ƒåº¦
- **å¼‚æ­¥æ’ä»¶ (AsyncSearchPlugin)**: å®ç°å¼‚æ­¥æœç´¢æ¥å£çš„æ’ä»¶
- **åŸºç¡€æ’ä»¶ (BaseAsyncPlugin)**: æä¾›é€šç”¨åŠŸèƒ½çš„åŸºç¡€ç»“æ„
- **å·¥ä½œæ± **: ç®¡ç†å¹¶å‘è¯·æ±‚å’Œèµ„æºé™åˆ¶
- **ç¼“å­˜ç³»ç»Ÿ**: äºŒçº§ç¼“å­˜æä¾›é«˜æ€§èƒ½æ•°æ®å­˜å‚¨

### å¼‚æ­¥å¤„ç†æœºåˆ¶

1. **åŒçº§è¶…æ—¶æ§åˆ¶**:
   - çŸ­è¶…æ—¶ (4ç§’): ç¡®ä¿å¿«é€Ÿå“åº”ç”¨æˆ·
   - é•¿è¶…æ—¶ (30ç§’): å…è®¸å®Œæ•´æ•°æ®å¤„ç†

2. **æ¸è¿›å¼ç»“æœè¿”å›**:
   - `isFinal=false`: éƒ¨åˆ†ç»“æœï¼Œç»§ç»­åå°å¤„ç†
   - `isFinal=true`: å®Œæ•´ç»“æœï¼Œåœæ­¢å¤„ç†

3. **æ™ºèƒ½ç¼“å­˜æ›´æ–°**:
   - å®æ—¶æ›´æ–°ä¸»ç¼“å­˜ (å†…å­˜+ç£ç›˜)
   - ç»“æœåˆå¹¶å»é‡
   - ç”¨æˆ·æ— æ„ŸçŸ¥æ•°æ®æ›´æ–°

## æ’ä»¶æ¥å£è§„èŒƒ

### AsyncSearchPlugin æ¥å£

```go
type AsyncSearchPlugin interface {
    // Name è¿”å›æ’ä»¶åç§° (å¿…é¡»å”¯ä¸€)
    Name() string
    
    // Priority è¿”å›æ’ä»¶ä¼˜å…ˆçº§ (1-4ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå½±å“æœç´¢ç»“æœæ’åº)
    Priority() int
    
    // AsyncSearch å¼‚æ­¥æœç´¢æ–¹æ³• (æ ¸å¿ƒæ–¹æ³•)
    AsyncSearch(keyword string, searchFunc func(*http.Client, string, map[string]interface{}) ([]model.SearchResult, error), mainCacheKey string, ext map[string]interface{}) ([]model.SearchResult, error)
    
    // SetMainCacheKey è®¾ç½®ä¸»ç¼“å­˜é”® (ç”±ç³»ç»Ÿè°ƒç”¨)
    SetMainCacheKey(key string)
    
    // SetCurrentKeyword è®¾ç½®å½“å‰æœç´¢å…³é”®è¯ (ç”¨äºæ—¥å¿—æ˜¾ç¤º)
    SetCurrentKeyword(keyword string)
    
    // Search åŒæ­¥æœç´¢æ–¹æ³• (å…¼å®¹æ€§æ–¹æ³•)
    Search(keyword string, ext map[string]interface{}) ([]model.SearchResult, error)
    
    // SkipServiceFilter è¿”å›æ˜¯å¦è·³è¿‡Serviceå±‚çš„å…³é”®è¯è¿‡æ»¤ (æ–°å¢åŠŸèƒ½)
    // å¯¹äºç£åŠ›æœç´¢ç­‰éœ€è¦å®½æ³›ç»“æœçš„æ’ä»¶ï¼Œåº”è¿”å›true
    SkipServiceFilter() bool
}
```

### å‚æ•°è¯´æ˜

- **keyword**: æœç´¢å…³é”®è¯
- **searchFunc**: HTTPæœç´¢å‡½æ•°ï¼Œå¤„ç†å®é™…çš„ç½‘ç»œè¯·æ±‚
- **mainCacheKey**: ä¸»ç¼“å­˜é”®ï¼Œç”¨äºç¼“å­˜ç®¡ç†
- **ext**: æ‰©å±•å‚æ•°ï¼Œæ”¯æŒè‡ªå®šä¹‰æœç´¢é€‰é¡¹

### Serviceå±‚è¿‡æ»¤æ§åˆ¶ (æ–°åŠŸèƒ½)

PanSouæ”¯æŒæ’ä»¶çº§åˆ«çš„Serviceå±‚è¿‡æ»¤æ§åˆ¶ï¼Œå…è®¸æ’ä»¶è‡ªä¸»å†³å®šæ˜¯å¦åœ¨Serviceå±‚è¿›è¡Œå…³é”®è¯è¿‡æ»¤ï¼š

#### è¿‡æ»¤æœºåˆ¶è¯´æ˜

1. **æ’ä»¶å±‚è¿‡æ»¤**: åœ¨æ’ä»¶å†…éƒ¨ä½¿ç”¨ `FilterResultsByKeyword()` è¿›è¡Œç²¾ç¡®è¿‡æ»¤
2. **Serviceå±‚è¿‡æ»¤**: åœ¨ `search_service.go` çš„ `mergeResultsByType()` ä¸­è¿›è¡ŒäºŒæ¬¡è¿‡æ»¤
3. **åŒå±‚è¿‡æ»¤é—®é¢˜**: æŸäº›æ’ä»¶ï¼ˆå¦‚ç£åŠ›æœç´¢ï¼‰éœ€è¦æ›´å®½æ³›çš„æœç´¢ç»“æœï¼ŒäºŒæ¬¡è¿‡æ»¤ä¼šè¯¯åˆ æœ‰æ•ˆç»“æœ

#### é€‚ç”¨åœºæ™¯

**åº”è¯¥è·³è¿‡Serviceå±‚è¿‡æ»¤çš„æ’ä»¶ç±»å‹**:
- âœ… **ç£åŠ›æœç´¢æ’ä»¶**: å¦‚ thepiratebayï¼Œæ ‡é¢˜æ ¼å¼ç‰¹æ®Šï¼ˆç‚¹å·åˆ†éš”ï¼‰ï¼Œéœ€è¦å®½æ³›åŒ¹é…
- âœ… **å›½å¤–èµ„æºæ’ä»¶**: è‹±æ–‡èµ„æºæ ‡é¢˜ä¸ä¸­æ–‡å…³é”®è¯åŒ¹é…åº¦ä½
- âœ… **ç‰¹æ®Šæ ¼å¼æ’ä»¶**: æ ‡é¢˜åŒ…å«å¤§é‡ç¬¦å·æˆ–ç¼–ç ï¼Œæ ‡å‡†è¿‡æ»¤å¯èƒ½å¤±æ•ˆ
- âœ… **èšåˆæœç´¢æ’ä»¶**: éœ€è¦ä¿ç•™æ‰€æœ‰ç›¸å…³ç»“æœä¾›ç”¨æˆ·ç­›é€‰

**åº”è¯¥ä¿æŒServiceå±‚è¿‡æ»¤çš„æ’ä»¶ç±»å‹**:
- âš ï¸ **ç½‘ç›˜æœç´¢æ’ä»¶**: æ ‡å‡†ä¸­æ–‡èµ„æºï¼Œè¿‡æ»¤æœ‰åŠ©äºæé«˜ç²¾ç¡®åº¦
- âš ï¸ **APIæ¥å£æ’ä»¶**: ç»“æ„åŒ–æ•°æ®ï¼Œå…³é”®è¯åŒ¹é…å‡†ç¡®
- âš ï¸ **è®ºå›çˆ¬å–æ’ä»¶**: æ ‡é¢˜æ ¼å¼æ ‡å‡†ï¼Œè¿‡æ»¤æ•ˆæœè‰¯å¥½

## æ’ä»¶ä¼˜å…ˆçº§ç³»ç»Ÿ

### ä¼˜å…ˆçº§ç­‰çº§

PanSou é‡‡ç”¨4çº§æ’ä»¶ä¼˜å…ˆçº§ç³»ç»Ÿï¼Œç›´æ¥å½±å“æœç´¢ç»“æœçš„æ’åºæƒé‡ï¼š

| ç­‰çº§ | å¾—åˆ† | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹æ’ä»¶ |
|------|------|----------|----------|
| **ç­‰çº§1** | **1000åˆ†** | é«˜è´¨é‡ã€ç¨³å®šå¯é çš„æ•°æ®æº | panta, zhizhen, labi |
| **ç­‰çº§2** | **500åˆ†** | è´¨é‡è‰¯å¥½ã€å“åº”ç¨³å®šçš„æ•°æ®æº | huban, shandian, duoduo |
| **ç­‰çº§3** | **0åˆ†** | æ™®é€šè´¨é‡çš„æ•°æ®æº | pansearch, hunhepan, pan666 |
| **ç­‰çº§4** | **-200åˆ†** | è´¨é‡è¾ƒä½æˆ–ä¸ç¨³å®šçš„æ•°æ®æº | - |

### æ’åºç®—æ³•å½±å“

æ’ä»¶ä¼˜å…ˆçº§åœ¨PanSouçš„å¤šç»´åº¦æ’åºç®—æ³•ä¸­å æ®ä¸»å¯¼åœ°ä½ï¼š

```
æ€»å¾—åˆ† = æ’ä»¶å¾—åˆ†(1000/500/0/-200) + æ—¶é—´å¾—åˆ†(æœ€é«˜500) + å…³é”®è¯å¾—åˆ†(æœ€é«˜420)
```

**æƒé‡åˆ†é…**ï¼š
- ğŸ¥‡ **æ’ä»¶ç­‰çº§**: ~52% (ä¸»å¯¼å› ç´ )
- ğŸ¥ˆ **å…³é”®è¯åŒ¹é…**: ~22% (é‡è¦å› ç´ )  
- ğŸ¥‰ **æ—¶é—´æ–°é²œåº¦**: ~26% (é‡è¦å› ç´ )

**å®é™…æ•ˆæœ**ï¼š
- ç­‰çº§1æ’ä»¶çš„ç»“æœé€šå¸¸æ’åœ¨å‰åˆ—
- å³ä½¿æ˜¯è¾ƒæ—§çš„ç­‰çº§1æ’ä»¶ç»“æœï¼Œä¹Ÿä¼šä¼˜äºæ–°çš„ç­‰çº§3æ’ä»¶ç»“æœ
- åŒ…å«ä¼˜å…ˆå…³é”®è¯çš„ç­‰çº§2æ’ä»¶å¯èƒ½è¶…è¶Šç­‰çº§1æ’ä»¶

### å¦‚ä½•é€‰æ‹©ä¼˜å…ˆçº§

åœ¨å¼€å‘æ–°æ’ä»¶æ—¶ï¼Œåº”æ ¹æ®ä»¥ä¸‹æ ‡å‡†é€‰æ‹©åˆé€‚çš„ä¼˜å…ˆçº§ï¼š

#### é€‰æ‹©ç­‰çº§1çš„æ¡ä»¶
- âœ… æ•°æ®æºè´¨é‡æé«˜ï¼Œå¾ˆå°‘å‡ºç°æ— æ•ˆé“¾æ¥
- âœ… æœåŠ¡ç¨³å®šæ€§å¥½ï¼Œå“åº”æ—¶é—´çŸ­
- âœ… æ•°æ®æ›´æ–°é¢‘ç‡é«˜ï¼Œå†…å®¹æ–°é¢–
- âœ… é“¾æ¥æœ‰æ•ˆæ€§é«˜ï¼ˆ>90%ï¼‰

#### é€‰æ‹©ç­‰çº§2çš„æ¡ä»¶  
- âœ… æ•°æ®æºè´¨é‡è‰¯å¥½ï¼Œå¶æœ‰æ— æ•ˆé“¾æ¥
- âœ… æœåŠ¡ç›¸å¯¹ç¨³å®šï¼Œå“åº”æ—¶é—´é€‚ä¸­
- âœ… æ•°æ®æ›´æ–°è¾ƒä¸ºåŠæ—¶
- âœ… é“¾æ¥æœ‰æ•ˆæ€§ä¸­ç­‰ï¼ˆ70-90%ï¼‰

#### é€‰æ‹©ç­‰çº§3çš„æ¡ä»¶
- âš ï¸ æ•°æ®æºè´¨é‡ä¸€èˆ¬ï¼Œå­˜åœ¨ä¸€å®šæ¯”ä¾‹æ— æ•ˆé“¾æ¥
- âš ï¸ æœåŠ¡ç¨³å®šæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å¶æœ‰è¶…æ—¶
- âš ï¸ æ•°æ®æ›´æ–°ä¸å¤ŸåŠæ—¶
- âš ï¸ é“¾æ¥æœ‰æ•ˆæ€§è¾ƒä½ï¼ˆ50-70%ï¼‰

#### é€‰æ‹©ç­‰çº§4çš„æ¡ä»¶
- âŒ æ•°æ®æºè´¨é‡è¾ƒå·®ï¼Œå¤§é‡æ— æ•ˆé“¾æ¥
- âŒ æœåŠ¡ä¸ç¨³å®šï¼Œç»å¸¸è¶…æ—¶æˆ–å¤±è´¥
- âŒ æ•°æ®æ›´æ–°ç¼“æ…¢æˆ–è¿‡æ—¶
- âŒ é“¾æ¥æœ‰æ•ˆæ€§å¾ˆä½ï¼ˆ<50%ï¼‰

### å¯åŠ¨æ—¶æ˜¾ç¤º

ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šæŒ‰ä¼˜å…ˆçº§æ’åºæ˜¾ç¤ºæ‰€æœ‰å·²åŠ è½½çš„æ’ä»¶ï¼š

```
å·²åŠ è½½æ’ä»¶:
  - panta (ä¼˜å…ˆçº§: 1)
  - zhizhen (ä¼˜å…ˆçº§: 1)  
  - labi (ä¼˜å…ˆçº§: 1)
  - huban (ä¼˜å…ˆçº§: 2)
  - duoduo (ä¼˜å…ˆçº§: 2)
  - pansearch (ä¼˜å…ˆçº§: 3)
  - hunhepan (ä¼˜å…ˆçº§: 3)
```

## å¼€å‘æ–°æ’ä»¶

### 1. åŸºç¡€ç»“æ„

```go
package myplugin

import (
    "context"
    "io"
    "net/http"
    "time"
    "pansou/model"
    "pansou/plugin"
    "pansou/util/json"  // ä½¿ç”¨é¡¹ç›®ç»Ÿä¸€çš„é«˜æ€§èƒ½JSONå·¥å…·
)

type MyPlugin struct {
    *plugin.BaseAsyncPlugin
}

func init() {
    p := &MyPlugin{
        BaseAsyncPlugin: plugin.NewBaseAsyncPlugin("myplugin", 3), // ä¼˜å…ˆçº§3 = æ™®é€šè´¨é‡æ•°æ®æº
    }
    plugin.RegisterGlobalPlugin(p)
}

// å¯¹äºéœ€è¦è·³è¿‡Serviceå±‚è¿‡æ»¤çš„æ’ä»¶ï¼ˆå¦‚ç£åŠ›æœç´¢æ’ä»¶ï¼‰
func init() {
    p := &MyMagnetPlugin{
        BaseAsyncPlugin: plugin.NewBaseAsyncPluginWithFilter("mymagnet", 4, true), // è·³è¿‡Serviceå±‚è¿‡æ»¤
    }
    plugin.RegisterGlobalPlugin(p)
}

// Search æ‰§è¡Œæœç´¢å¹¶è¿”å›ç»“æœï¼ˆå…¼å®¹æ€§æ–¹æ³•ï¼‰
func (p *MyPlugin) Search(keyword string, ext map[string]interface{}) ([]model.SearchResult, error) {
    result, err := p.SearchWithResult(keyword, ext)
    if err != nil {
        return nil, err
    }
    return result.Results, nil
}

// SearchWithResult æ‰§è¡Œæœç´¢å¹¶è¿”å›åŒ…å«IsFinalæ ‡è®°çš„ç»“æœï¼ˆæ¨èæ–¹æ³•ï¼‰
func (p *MyPlugin) SearchWithResult(keyword string, ext map[string]interface{}) (model.PluginSearchResult, error) {
    return p.AsyncSearchWithResult(keyword, p.searchImpl, p.MainCacheKey, ext)
}
```

### 2. å®ç°æœç´¢é€»è¾‘ï¼ˆâ­ æ¨èå®ç°æ¨¡å¼ï¼‰

```go
func (p *MyPlugin) searchImpl(client *http.Client, keyword string, ext map[string]interface{}) ([]model.SearchResult, error) {
    // 1. æ„å»ºè¯·æ±‚URL
    searchURL := fmt.Sprintf("https://api.example.com/search?q=%s", url.QueryEscape(keyword))
    
    // 2. å¤„ç†æ‰©å±•å‚æ•°
    if titleEn, ok := ext["title_en"].(string); ok && titleEn != "" {
        searchURL += "&title_en=" + url.QueryEscape(titleEn)
    }
    
    // 3. åˆ›å»ºå¸¦è¶…æ—¶çš„ä¸Šä¸‹æ–‡ â­ é‡è¦ï¼šé¿å…è¯·æ±‚è¶…æ—¶
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()
    
    // 4. åˆ›å»ºè¯·æ±‚å¯¹è±¡ â­ é‡è¦ï¼šä½¿ç”¨contextæ§åˆ¶è¶…æ—¶
    req, err := http.NewRequestWithContext(ctx, "GET", searchURL, nil)
    if err != nil {
        return nil, fmt.Errorf("[%s] åˆ›å»ºè¯·æ±‚å¤±è´¥: %w", p.Name(), err)
    }
    
    // 5. è®¾ç½®å®Œæ•´è¯·æ±‚å¤´ â­ é‡è¦ï¼šé¿å…åçˆ¬è™«æ£€æµ‹
    req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36")
    req.Header.Set("Accept", "application/json, text/plain, */*")
    req.Header.Set("Accept-Language", "zh-CN,zh;q=0.9,en;q=0.8")
    req.Header.Set("Connection", "keep-alive")
    req.Header.Set("Referer", "https://api.example.com/")
    
    // 6. å‘é€HTTPè¯·æ±‚ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰â­ é‡è¦ï¼šæé«˜ç¨³å®šæ€§
    resp, err := p.doRequestWithRetry(req, client)
    if err != nil {
        return nil, fmt.Errorf("[%s] æœç´¢è¯·æ±‚å¤±è´¥: %w", p.Name(), err)
    }
    defer resp.Body.Close()
    
    // 7. æ£€æŸ¥çŠ¶æ€ç 
    if resp.StatusCode != 200 {
        return nil, fmt.Errorf("[%s] è¯·æ±‚è¿”å›çŠ¶æ€ç : %d", p.Name(), resp.StatusCode)
    }
    
    // 8. è§£æå“åº”
    var apiResp APIResponse
    if err := json.NewDecoder(resp.Body).Decode(&apiResp); err != nil {
        return nil, fmt.Errorf("[%s] JSONè§£æå¤±è´¥: %w", p.Name(), err)
    }
    
    // 9. è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
    results := make([]model.SearchResult, 0, len(apiResp.Data))
    for _, item := range apiResp.Data {
        result := model.SearchResult{
            UniqueID:  fmt.Sprintf("%s-%s", p.Name(), item.ID),
            Title:     item.Title,
            Content:   item.Description,
            Datetime:  item.CreateTime,
            Tags:      item.Tags,
            Links:     convertLinks(item.Links), // è½¬æ¢é“¾æ¥æ ¼å¼
        }
        results = append(results, result)
    }
    
    // 10. å…³é”®è¯è¿‡æ»¤
    return plugin.FilterResultsByKeyword(results, keyword), nil
}

// doRequestWithRetry å¸¦é‡è¯•æœºåˆ¶çš„HTTPè¯·æ±‚ â­ é‡è¦ï¼šæé«˜ç¨³å®šæ€§
func (p *MyPlugin) doRequestWithRetry(req *http.Request, client *http.Client) (*http.Response, error) {
    maxRetries := 3
    var lastErr error
    
    for i := 0; i < maxRetries; i++ {
        if i > 0 {
            // æŒ‡æ•°é€€é¿é‡è¯•
            backoff := time.Duration(1<<uint(i-1)) * 200 * time.Millisecond
            time.Sleep(backoff)
        }
        
        // å…‹éš†è¯·æ±‚é¿å…å¹¶å‘é—®é¢˜
        reqClone := req.Clone(req.Context())
        
        resp, err := client.Do(reqClone)
        if err == nil && resp.StatusCode == 200 {
            return resp, nil
        }
        
        if resp != nil {
            resp.Body.Close()
        }
        lastErr = err
    }
    
    return nil, fmt.Errorf("é‡è¯• %d æ¬¡åä»ç„¶å¤±è´¥: %w", maxRetries, lastErr)
}
```

### 3. é“¾æ¥è½¬æ¢ä¸ work_title å­—æ®µ

#### Link ç»“æ„å®šä¹‰

```go
type Link struct {
    Type      string    `json:"type"`                                    // ç½‘ç›˜ç±»å‹
    URL       string    `json:"url"`                                     // é“¾æ¥åœ°å€
    Password  string    `json:"password"`                                // æå–ç /å¯†ç 
    Datetime  time.Time `json:"datetime,omitempty"`                      // é“¾æ¥æ›´æ–°æ—¶é—´ï¼ˆå¯é€‰ï¼‰
    WorkTitle string    `json:"work_title,omitempty"`                    // ä½œå“æ ‡é¢˜ï¼ˆé‡è¦ï¼šç”¨äºåŒºåˆ†åŒä¸€æ¶ˆæ¯ä¸­å¤šä¸ªä½œå“çš„é“¾æ¥ï¼‰
}
```

#### work_title å­—æ®µè¯¦è§£

**å­—æ®µä½œç”¨**:
- ç”¨äºåŒºåˆ†**åŒä¸€æ¡æ¶ˆæ¯/ç»“æœä¸­åŒ…å«çš„å¤šä¸ªä¸åŒä½œå“**çš„é“¾æ¥
- ç‰¹åˆ«é€‚ç”¨äºè®ºå›å¸–å­ã€TGé¢‘é“æ¶ˆæ¯ç­‰ä¸€æ¬¡æ€§å‘å¸ƒå¤šéƒ¨å½±è§†èµ„æºçš„åœºæ™¯

**ä½¿ç”¨åœºæ™¯ç¤ºä¾‹**:

```
ğŸ“º TGé¢‘é“æ¶ˆæ¯ç¤ºä¾‹ï¼š
ã€ä»Šæ—¥æ›´æ–°ã€‘å¤šéƒ¨çƒ­é—¨å‰§é›†
1. å‡¡äººä¿®ä»™ä¼  ç¬¬30é›†
   å¤¸å…‹ï¼šhttps://pan.quark.cn/s/abc123
2. å”æœè¯¡äº‹å½• ç¬¬20é›†
   å¤¸å…‹ï¼šhttps://pan.quark.cn/s/def456
3. åº†ä½™å¹´2 å…¨é›†
   ç™¾åº¦ï¼šhttps://pan.baidu.com/s/xyz789?pwd=abcd
```

**ä¸ä½¿ç”¨ work_title çš„é—®é¢˜**:
- æ‰€æœ‰é“¾æ¥çš„æ ‡é¢˜éƒ½æ˜¯ "ã€ä»Šæ—¥æ›´æ–°ã€‘å¤šéƒ¨çƒ­é—¨å‰§é›†"
- ç”¨æˆ·æ— æ³•åŒºåˆ†å“ªä¸ªé“¾æ¥å¯¹åº”å“ªéƒ¨å‰§é›†

**ä½¿ç”¨ work_title åçš„æ•ˆæœ**:
```go
links := []model.Link{
    {
        Type:      "quark",
        URL:       "https://pan.quark.cn/s/abc123",
        WorkTitle: "å‡¡äººä¿®ä»™ä¼  ç¬¬30é›†",  // ç‹¬ç«‹ä½œå“æ ‡é¢˜
    },
    {
        Type:      "quark", 
        URL:       "https://pan.quark.cn/s/def456",
        WorkTitle: "å”æœè¯¡äº‹å½• ç¬¬20é›†",  // ç‹¬ç«‹ä½œå“æ ‡é¢˜
    },
    {
        Type:      "baidu",
        URL:       "https://pan.baidu.com/s/xyz789?pwd=abcd",
        Password:  "abcd",
        WorkTitle: "åº†ä½™å¹´2 å…¨é›†",       // ç‹¬ç«‹ä½œå“æ ‡é¢˜
    },
}
```

**PanSouç³»ç»Ÿçš„æ™ºèƒ½å¤„ç†**:

PanSou ä¼šæ ¹æ®æ¶ˆæ¯ä¸­çš„é“¾æ¥æ•°é‡è‡ªåŠ¨å†³å®šæ˜¯å¦æå– work_titleï¼š

1. **é“¾æ¥æ•°é‡ â‰¤ 4**ï¼šæ‰€æœ‰é“¾æ¥ä½¿ç”¨ç›¸åŒçš„ work_titleï¼ˆå³æ¶ˆæ¯æ ‡é¢˜ï¼‰
   ```go
   // ç¤ºä¾‹ï¼šä¸€æ¡æ¶ˆæ¯åªåŒ…å«åŒä¸€éƒ¨å‰§çš„ä¸åŒç½‘ç›˜é“¾æ¥
   // æ¶ˆæ¯æ ‡é¢˜ï¼š"å‡¡äººä¿®ä»™ä¼  ç¬¬30é›†"
   // é“¾æ¥1(å¤¸å…‹)ã€é“¾æ¥2(ç™¾åº¦) â†’ work_title éƒ½æ˜¯ "å‡¡äººä¿®ä»™ä¼  ç¬¬30é›†"
   ```

2. **é“¾æ¥æ•°é‡ > 4**ï¼šç³»ç»Ÿæ™ºèƒ½è¯†åˆ«æ¯ä¸ªé“¾æ¥å¯¹åº”çš„ä½œå“æ ‡é¢˜
   ```go
   // ç¤ºä¾‹ï¼šä¸€æ¡æ¶ˆæ¯åŒ…å«5ä¸ªä¸åŒä½œå“çš„é“¾æ¥
   // ç³»ç»Ÿä¼šåˆ†ææ¶ˆæ¯æ–‡æœ¬ï¼Œä¸ºæ¯ä¸ªé“¾æ¥æå–ç‹¬ç«‹çš„ work_title
   ```

**æ’ä»¶å®ç° work_title çš„ä¸¤ç§æ–¹å¼**:

**æ–¹å¼1: ä¾èµ–ç³»ç»Ÿè‡ªåŠ¨æå–**ï¼ˆé€‚ç”¨äºTGé¢‘é“ã€è®ºå›ç­‰ï¼‰
```go
// ç›´æ¥è¿”å›é“¾æ¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨ extractWorkTitlesForLinks è¿›è¡Œå¤„ç†
links := []model.Link{
    {Type: "quark", URL: "https://pan.quark.cn/s/abc123"},
    {Type: "baidu", URL: "https://pan.baidu.com/s/xyz789"},
}
// PanSouä¼šæ ¹æ®æ¶ˆæ¯æ–‡æœ¬è‡ªåŠ¨ä¸ºæ¯ä¸ªé“¾æ¥æå–work_title
```

**æ–¹å¼2: æ’ä»¶æ‰‹åŠ¨è®¾ç½®**ï¼ˆé€‚ç”¨äºAPIæ’ä»¶ã€ç£åŠ›æœç´¢ç­‰ï¼‰
```go
// æ’ä»¶ç›´æ¥è®¾ç½® work_titleï¼ˆå¦‚feikuaiã€thepiratebayç­‰ï¼‰
links := []model.Link{
    {
        Type:      "magnet",
        URL:       magnetURL,
        WorkTitle: buildWorkTitle(keyword, fileName), // æ’ä»¶è‡ªå·±æ„å»º
        Datetime:  publishedTime,
    },
}
```

**æ’ä»¶å¼€å‘å»ºè®®**:
- **ç½‘ç›˜APIæ’ä»¶**: å¦‚æœAPIç›´æ¥è¿”å›å•ä¸€ä½œå“ï¼Œå¯ä»¥ä¸è®¾ç½® work_titleï¼ˆç•™ç©ºï¼‰
- **ç£åŠ›æœç´¢æ’ä»¶**: å»ºè®®è®¾ç½® work_titleï¼Œç‰¹åˆ«æ˜¯æ–‡ä»¶åä¸å«ä¸­æ–‡æ—¶éœ€è¦æ‹¼æ¥å…³é”®è¯
- **çˆ¬è™«æ’ä»¶**: å¦‚æœèƒ½ä»é¡µé¢æå–æ¯ä¸ªé“¾æ¥çš„ç‹¬ç«‹æ ‡é¢˜ï¼Œå»ºè®®è®¾ç½® work_title

#### æ”¯æŒçš„ç½‘ç›˜ç±»å‹

PanSouç³»ç»Ÿæ”¯æŒä»¥ä¸‹ç½‘ç›˜ç±»å‹çš„è‡ªåŠ¨è¯†åˆ«ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰ï¼š

| ç½‘ç›˜ç±»å‹ | ç±»å‹æ ‡è¯† | åŸŸåç‰¹å¾ | è¯´æ˜ |
|---------|---------|----------|------|
| **å¤¸å…‹ç½‘ç›˜** | `quark` | `pan.quark.cn` | ä¸»æµç½‘ç›˜ |
| **UCç½‘ç›˜** | `uc` | `drive.uc.cn` | ä¸»æµç½‘ç›˜ |
| **ç™¾åº¦ç½‘ç›˜** | `baidu` | `pan.baidu.com` | ä¸»æµç½‘ç›˜ |
| **é˜¿é‡Œäº‘ç›˜** | `aliyun` | `aliyundrive.com`, `alipan.com` | ä¸»æµç½‘ç›˜ |
| **è¿…é›·ç½‘ç›˜** | `xunlei` | `pan.xunlei.com` | ä¸»æµç½‘ç›˜ |
| **å¤©ç¿¼äº‘ç›˜** | `tianyi` | `cloud.189.cn` | ä¸»æµç½‘ç›˜ |
| **115ç½‘ç›˜** | `115` | `115.com`,`115cdn.com`,`anxia.com` | ä¸»æµç½‘ç›˜ |
| **123ç½‘ç›˜** | `123` | `123pan.com`,`123684.com`,`123685.com`,`123912.com`,`123pan.cn`,`123592.com` | ä¸»æµç½‘ç›˜ |
| **ç§»åŠ¨äº‘ç›˜** | `mobile` | `caiyun.139.com` | å…¶ä»–ç½‘ç›˜ |
| **PikPak** | `pikpak` | `mypikpak.com` | å…¶ä»–ç½‘ç›˜ |
| **ç£åŠ›é“¾æ¥** | `magnet` | `magnet:?xt=urn:btih:` | ç£åŠ›é“¾æ¥ |
| **ED2Ké“¾æ¥** | `ed2k` | `ed2k://` | ç£åŠ›é“¾æ¥ |

```go
func convertLinks(apiLinks []APILink) []model.Link {
    links := make([]model.Link, 0, len(apiLinks))
    for _, apiLink := range apiLinks {
        link := model.Link{
            Type:     determineCloudType(apiLink.URL), // è‡ªåŠ¨è¯†åˆ«ç½‘ç›˜ç±»å‹
            URL:      apiLink.URL,
            Password: apiLink.Password,
        }
        links = append(links, link)
    }
    return links
}

func determineCloudType(url string) string {
    switch {
    case strings.Contains(url, "pan.quark.cn"):
        return "quark"
    case strings.Contains(url, "drive.uc.cn"):
        return "uc"
    case strings.Contains(url, "pan.baidu.com"):
        return "baidu"
    case strings.Contains(url, "aliyundrive.com") || strings.Contains(url, "alipan.com"):
        return "aliyun"
    case strings.Contains(url, "pan.xunlei.com"):
        return "xunlei"
    case strings.Contains(url, "cloud.189.cn"):
        return "tianyi"
    case strings.Contains(url, "115.com") || strings.Contains(url, "115cdn.com") || strings.Contains(url, "anxia.com"):
        return "115"
    case strings.Contains(url, "123684.com") || strings.Contains(url, "123685.com") || 
		strings.Contains(url, "123912.com") || strings.Contains(url, "123pan.com") || 
		strings.Contains(url, "123pan.cn") || strings.Contains(url, "123592.com"): 
		return "123"
    case strings.Contains(url, "caiyun.139.com"):
        return "mobile"
    case strings.Contains(url, "mypikpak.com"):
        return "pikpak"
    case strings.Contains(url, "magnet:"):
        return "magnet"
    case strings.Contains(url, "ed2k://"):
        return "ed2k"
    default:
        return "others"
    }
}

// ä½¿ç”¨ç¤ºä¾‹
func convertAPILinks(apiLinks []APILink) []model.Link {
    links := make([]model.Link, 0, len(apiLinks))
    for _, apiLink := range apiLinks {
        // è‡ªåŠ¨è¯†åˆ«ç½‘ç›˜ç±»å‹
        cloudType := determineCloudType(apiLink.URL)
        
        // åªæ·»åŠ è¯†åˆ«æˆåŠŸçš„é“¾æ¥
        if cloudType != "others" || strings.HasPrefix(apiLink.URL, "http") {
            link := model.Link{
                Type:     cloudType,
                URL:      apiLink.URL,
                Password: apiLink.Password,
            }
            links = append(links, link)
        }
    }
    return links
}
```

## é«˜çº§ç‰¹æ€§

### 1. æ’ä»¶Webè·¯ç”±æ³¨å†Œï¼ˆè‡ªå®šä¹‰HTTPæ¥å£ï¼‰

#### æ¦‚è¿°

PanSou æ”¯æŒæ’ä»¶æ³¨å†Œè‡ªå®šä¹‰çš„ HTTP è·¯ç”±ï¼Œç”¨äºå®ç°æ’ä»¶ä¸“å±çš„ç®¡ç†é¡µé¢ã€é…ç½®æ¥å£æˆ–å…¶ä»–WebåŠŸèƒ½ã€‚

**å…¸å‹åº”ç”¨åœºæ™¯**:
- æ’ä»¶é…ç½®ç®¡ç†ç•Œé¢ï¼ˆå¦‚ QQPD çš„ç”¨æˆ·ç™»å½•å’Œé¢‘é“ç®¡ç†ï¼‰
- æ’ä»¶æ•°æ®æŸ¥è¯¢æ¥å£
- æ’ä»¶çŠ¶æ€ç›‘æ§é¡µé¢
- OAuthå›è°ƒæ¥å£

#### æ¥å£å®šä¹‰

```go
// PluginWithWebHandler æ”¯æŒWebè·¯ç”±çš„æ’ä»¶æ¥å£
// æ’ä»¶å¯ä»¥é€‰æ‹©å®ç°æ­¤æ¥å£æ¥æ³¨å†Œè‡ªå®šä¹‰çš„HTTPè·¯ç”±
type PluginWithWebHandler interface {
    AsyncSearchPlugin // ç»§æ‰¿æœç´¢æ’ä»¶æ¥å£
    
    // RegisterWebRoutes æ³¨å†ŒWebè·¯ç”±
    // router: ginçš„è·¯ç”±ç»„ï¼Œæ’ä»¶å¯ä»¥åœ¨æ­¤æ³¨å†Œè‡ªå·±çš„è·¯ç”±
    RegisterWebRoutes(router *gin.RouterGroup)
}
```

#### å®ç°æ­¥éª¤

**æ­¥éª¤1: æ’ä»¶ç»“æ„å®ç°æ¥å£**

```go
package myplugin

import (
    "github.com/gin-gonic/gin"
    "pansou/plugin"
    "pansou/model"
)

type MyPlugin struct {
    *plugin.BaseAsyncPlugin
    // ... å…¶ä»–å­—æ®µ
}

// ç¡®ä¿æ’ä»¶å®ç°äº† PluginWithWebHandler æ¥å£
var _ plugin.PluginWithWebHandler = (*MyPlugin)(nil)
```

**æ­¥éª¤2: å®ç° RegisterWebRoutes æ–¹æ³•**

```go
// RegisterWebRoutes æ³¨å†ŒWebè·¯ç”±
func (p *MyPlugin) RegisterWebRoutes(router *gin.RouterGroup) {
    // åˆ›å»ºæ’ä»¶ä¸“å±çš„è·¯ç”±ç»„
    myGroup := router.Group("/myplugin")
    
    // æ³¨å†ŒGETè·¯ç”±
    myGroup.GET("/status", p.handleGetStatus)
    
    // æ³¨å†ŒPOSTè·¯ç”±
    myGroup.POST("/config", p.handleUpdateConfig)
    
    // æ”¯æŒåŠ¨æ€è·¯å¾„å‚æ•°
    myGroup.GET("/:id", p.handleGetByID)
    myGroup.POST("/:id/action", p.handleAction)
}
```

**æ­¥éª¤3: å®ç°è·¯ç”±å¤„ç†å‡½æ•°**

```go
// handleGetStatus è·å–æ’ä»¶çŠ¶æ€
func (p *MyPlugin) handleGetStatus(c *gin.Context) {
    c.JSON(200, gin.H{
        "status": "ok",
        "plugin": p.Name(),
        "version": "1.0.0",
    })
}

// handleUpdateConfig æ›´æ–°æ’ä»¶é…ç½®
func (p *MyPlugin) handleUpdateConfig(c *gin.Context) {
    var config map[string]interface{}
    
    if err := c.BindJSON(&config); err != nil {
        c.JSON(400, gin.H{"error": "Invalid JSON"})
        return
    }
    
    // å¤„ç†é…ç½®æ›´æ–°é€»è¾‘
    // ...
    
    c.JSON(200, gin.H{
        "success": true,
        "message": "é…ç½®å·²æ›´æ–°",
    })
}

// handleGetByID æ ¹æ®IDè·å–æ•°æ®
func (p *MyPlugin) handleGetByID(c *gin.Context) {
    id := c.Param("id")
    
    // æ ¹æ®IDæŸ¥è¯¢æ•°æ®
    // ...
    
    c.JSON(200, gin.H{
        "id": id,
        "data": "...",
    })
}
```

#### å®é™…æ¡ˆä¾‹: QQPD æ’ä»¶

QQPD æ’ä»¶å®ç°äº†å®Œæ•´çš„ç”¨æˆ·ç®¡ç†å’Œé¢‘é“é…ç½®åŠŸèƒ½ï¼š

```go
// RegisterWebRoutes æ³¨å†ŒWebè·¯ç”±
func (p *QQPDPlugin) RegisterWebRoutes(router *gin.RouterGroup) {
    qqpd := router.Group("/qqpd")
    
    // GET /:param - æ˜¾ç¤ºç®¡ç†é¡µé¢ï¼ˆHTMLï¼‰
    qqpd.GET("/:param", p.handleManagePage)
    
    // POST /:param - å¤„ç†ç®¡ç†æ“ä½œï¼ˆJSON APIï¼‰
    qqpd.POST("/:param", p.handleManagePagePOST)
}

// handleManagePage æ¸²æŸ“ç®¡ç†é¡µé¢
func (p *QQPDPlugin) handleManagePage(c *gin.Context) {
    param := c.Param("param")
    
    // ç”Ÿæˆç”¨æˆ·ä¸“å±çš„ç®¡ç†é¡µé¢
    html := strings.ReplaceAll(HTMLTemplate, "HASH_PLACEHOLDER", param)
    
    c.Header("Content-Type", "text/html; charset=utf-8")
    c.String(200, html)
}

// handleManagePagePOST å¤„ç†ç®¡ç†æ“ä½œ
func (p *QQPDPlugin) handleManagePagePOST(c *gin.Context) {
    param := c.Param("param")
    
    var req struct {
        Action   string   `json:"action"`
        Channels []string `json:"channels,omitempty"`
        Keyword  string   `json:"keyword,omitempty"`
    }
    
    if err := c.BindJSON(&req); err != nil {
        respondError(c, "æ— æ•ˆçš„è¯·æ±‚æ ¼å¼")
        return
    }
    
    // æ ¹æ®ä¸åŒçš„ action æ‰§è¡Œä¸åŒçš„æ“ä½œ
    switch req.Action {
    case "get_status":
        p.handleGetStatus(c, param)
    case "set_channels":
        p.handleSetChannels(c, param, req.Channels)
    case "test_search":
        p.handleTestSearch(c, param, req.Keyword)
    case "logout":
        p.handleLogout(c, param)
    default:
        respondError(c, "æœªçŸ¥çš„æ“ä½œ")
    }
}
```

#### å®é™…æ¡ˆä¾‹: Gying æ’ä»¶

```go
// RegisterWebRoutes æ³¨å†ŒWebè·¯ç”±
func (p *GyingPlugin) RegisterWebRoutes(router *gin.RouterGroup) {
    gying := router.Group("/gying")
    gying.GET("/:param", p.handleManagePage)
    gying.POST("/:param", p.handleManagePagePOST)
}
```

#### è·¯ç”±è®¿é—®ç¤ºä¾‹

æ’ä»¶æ³¨å†Œçš„è·¯ç”±å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®ï¼š

```bash
# QQPD æ’ä»¶ç®¡ç†é¡µé¢
GET  http://localhost:8888/qqpd/user123

# QQPD æ’ä»¶é…ç½®æ¥å£
POST http://localhost:8888/qqpd/user123
Content-Type: application/json
{
  "action": "set_channels",
  "channels": ["pd97631607", "kuake12345"]
}

# è‡ªå®šä¹‰æ’ä»¶æ¥å£
GET  http://localhost:8888/myplugin/status
POST http://localhost:8888/myplugin/config
GET  http://localhost:8888/myplugin/resource123
```

#### ç³»ç»Ÿé›†æˆ

PanSou åœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰å®ç°äº† `PluginWithWebHandler` æ¥å£çš„æ’ä»¶è·¯ç”±ï¼š

```go
// api/router.go ä¸­çš„è‡ªåŠ¨æ³¨å†Œé€»è¾‘
func SetupRouter(searchService *service.SearchService) *gin.Engine {
    r := gin.Default()
    
    // ... å…¶ä»–è·¯ç”±é…ç½® ...
    
    // æ³¨å†Œæ’ä»¶çš„Webè·¯ç”±ï¼ˆå¦‚æœæ’ä»¶å®ç°äº†PluginWithWebHandleræ¥å£ï¼‰
    allPlugins := plugin.GetRegisteredPlugins()
    for _, p := range allPlugins {
        if webPlugin, ok := p.(plugin.PluginWithWebHandler); ok {
            webPlugin.RegisterWebRoutes(r.Group(""))
        }
    }
    
    return r
}
```

#### å¼€å‘å»ºè®®

1. **è·¯ç”±å‘½åè§„èŒƒ**: ä½¿ç”¨æ’ä»¶åä½œä¸ºè·¯ç”±å‰ç¼€ï¼Œé¿å…ä¸å…¶ä»–æ’ä»¶å†²çª
   ```go
   // âœ… æ¨è
   router.Group("/myplugin")
   
   // âŒ é¿å…
   router.Group("/config")  // å¯èƒ½ä¸å…¶ä»–æ’ä»¶å†²çª
   ```

2. **å®‰å…¨è€ƒè™‘**: 
   - å¯¹æ•æ„Ÿæ“ä½œè¿›è¡Œèº«ä»½éªŒè¯
   - éªŒè¯ç”¨æˆ·è¾“å…¥ï¼Œé˜²æ­¢æ³¨å…¥æ”»å‡»
   - ä½¿ç”¨å“ˆå¸Œæˆ–åŠ å¯†ä¿æŠ¤æ•æ„Ÿå‚æ•°

3. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
   ```go
   func respondError(c *gin.Context, message string) {
       c.JSON(400, gin.H{
           "success": false,
           "message": message,
       })
   }
   
   func respondSuccess(c *gin.Context, message string, data interface{}) {
       c.JSON(200, gin.H{
           "success": true,
           "message": message,
           "data":    data,
       })
   }
   ```

4. **HTMLæ¨¡æ¿**: å¯ä»¥å†…åµŒHTMLæ¨¡æ¿æä¾›ç®¡ç†ç•Œé¢
   ```go
   const HTMLTemplate = `<!DOCTYPE html>
   <html>
   <head>
       <title>æ’ä»¶ç®¡ç†</title>
   </head>
   <body>
       <h1>{{ .PluginName }} ç®¡ç†ç•Œé¢</h1>
       <!-- ... -->
   </body>
   </html>`
   ```

5. **å¯é€‰å®ç°**: Webè·¯ç”±æ˜¯**å¯é€‰åŠŸèƒ½**ï¼Œåªæœ‰éœ€è¦è‡ªå®šä¹‰HTTPæ¥å£çš„æ’ä»¶æ‰éœ€è¦å®ç°

### 2. Serviceå±‚è¿‡æ»¤æ§åˆ¶è¯¦è§£

#### æ„é€ å‡½æ•°é€‰æ‹©

```go
// æ ‡å‡†æ’ä»¶æ„é€ å‡½æ•°ï¼ˆé»˜è®¤å¯ç”¨Serviceå±‚è¿‡æ»¤ï¼‰
func NewStandardPlugin() *StandardPlugin {
    return &StandardPlugin{
        BaseAsyncPlugin: plugin.NewBaseAsyncPlugin("standard", 3), // é»˜è®¤skipServiceFilter=false
    }
}

// ç£åŠ›æœç´¢æ’ä»¶æ„é€ å‡½æ•°ï¼ˆè·³è¿‡Serviceå±‚è¿‡æ»¤ï¼‰
func NewMagnetPlugin() *MagnetPlugin {
    return &MagnetPlugin{
        BaseAsyncPlugin: plugin.NewBaseAsyncPluginWithFilter("magnet", 4, true), // skipServiceFilter=true
    }
}
```

#### å®é™…åº”ç”¨ç¤ºä¾‹

**ThePirateBayæ’ä»¶ç¤ºä¾‹**:
```go
// thepiratebayæ’ä»¶çš„å®é™…å®ç°
func NewThePirateBayPlugin() *ThePirateBayPlugin {
    return &ThePirateBayPlugin{
        BaseAsyncPlugin: plugin.NewBaseAsyncPluginWithFilter("thepiratebay", 4, true), // è·³è¿‡Serviceå±‚è¿‡æ»¤
        optimizedClient: createOptimizedHTTPClient(),
    }
}

func (p *ThePirateBayPlugin) searchImpl(client *http.Client, keyword string, ext map[string]interface{}) ([]model.SearchResult, error) {
    // æ”¯æŒè‹±æ–‡æœç´¢ä¼˜åŒ–
    searchKeyword := keyword
    if ext != nil {
        if titleEn, exists := ext["title_en"]; exists {
            if titleEnStr, ok := titleEn.(string); ok && titleEnStr != "" {
                searchKeyword = titleEnStr
            }
        }
    }
    
    // è·å–æœç´¢ç»“æœ
    allResults := p.fetchAllResults(client, searchKeyword)
    
    // æ ‡é¢˜æ ¼å¼ä¼˜åŒ–ï¼šå°†'.'æ›¿æ¢ä¸ºç©ºæ ¼ï¼Œæé«˜å…³é”®è¯åŒ¹é…å‡†ç¡®åº¦
    for i := range allResults {
        allResults[i].Title = strings.ReplaceAll(allResults[i].Title, ".", " ")
    }
    
    // æ’ä»¶å±‚è¿‡æ»¤ï¼ˆä½¿ç”¨å¤„ç†åçš„æœç´¢å…³é”®è¯ï¼‰
    filteredResults := plugin.FilterResultsByKeyword(allResults, searchKeyword)
    
    return filteredResults, nil
    // æ³¨æ„ï¼šServiceå±‚ä¼šé€šè¿‡SkipServiceFilter()æ–¹æ³•è·³è¿‡äºŒæ¬¡è¿‡æ»¤
}
```

#### è¿‡æ»¤ç­–ç•¥å¯¹æ¯”

| è¿‡æ»¤ç±»å‹ | æ ‡å‡†æ’ä»¶ | ç£åŠ›æœç´¢æ’ä»¶ |
|----------|----------|--------------|
| **æ’ä»¶å±‚è¿‡æ»¤** | âœ… ä½¿ç”¨åŸå§‹å…³é”®è¯ | âœ… ä½¿ç”¨searchKeywordï¼ˆæ”¯æŒtitle_enï¼‰ |
| **Serviceå±‚è¿‡æ»¤** | âœ… å†æ¬¡è¿‡æ»¤ | âŒ è·³è¿‡è¿‡æ»¤ |
| **ç»“æœç‰¹ç‚¹** | ç²¾ç¡®åŒ¹é… | å®½æ³›æœç´¢ |
| **é€‚ç”¨åœºæ™¯** | ä¸­æ–‡ç½‘ç›˜èµ„æº | è‹±æ–‡ç£åŠ›èµ„æº |

#### åŠ¨æ€è¿‡æ»¤æ£€æµ‹æœºåˆ¶

Serviceå±‚é€šè¿‡ä»¥ä¸‹æœºåˆ¶åŠ¨æ€åˆ¤æ–­æ˜¯å¦éœ€è¦è¿‡æ»¤ï¼š

```go
// service/search_service.go ä¸­çš„å®ç°
func mergeResultsByType(...) {
    // æ£€æŸ¥æ’ä»¶æ˜¯å¦éœ€è¦è·³è¿‡Serviceå±‚è¿‡æ»¤
    var skipKeywordFilter bool = false
    if result.UniqueID != "" && strings.Contains(result.UniqueID, "-") {
        parts := strings.SplitN(result.UniqueID, "-", 2)
        if len(parts) >= 1 {
            pluginName := parts[0]
            // é€šè¿‡æ’ä»¶æ³¨å†Œè¡¨åŠ¨æ€è·å–è¿‡æ»¤è®¾ç½®
            if pluginInstance, exists := plugin.GetPluginByName(pluginName); exists {
                skipKeywordFilter = pluginInstance.SkipServiceFilter()
            }
        }
    }
    
    // æ ¹æ®æ’ä»¶è®¾ç½®å†³å®šæ˜¯å¦è¿‡æ»¤
    if !skipKeywordFilter && keyword != "" && !strings.Contains(strings.ToLower(title), lowerKeyword) {
        continue // è¿‡æ»¤æ‰ä¸åŒ¹é…çš„ç»“æœ
    }
}
```

### 2. æ‰©å±•å‚æ•°å¤„ç†

```go
// æ”¯æŒçš„æ‰©å±•å‚æ•°ç¤ºä¾‹
ext := map[string]interface{}{
    "title_en": "English Title",     // è‹±æ–‡æ ‡é¢˜
    "is_all":   true,               // å…¨é‡æœç´¢æ ‡å¿—
    "year":     2023,               // å¹´ä»½é™åˆ¶
    "type":     "movie",            // å†…å®¹ç±»å‹
}

// åœ¨æ’ä»¶ä¸­å¤„ç†
func (p *MyPlugin) handleExtParams(ext map[string]interface{}) searchOptions {
    opts := searchOptions{}
    
    if titleEn, ok := ext["title_en"].(string); ok {
        opts.TitleEn = titleEn
    }
    
    if isAll, ok := ext["is_all"].(bool); ok {
        opts.IsAll = isAll
    }
    
    return opts
}
```

### 2. ç¼“å­˜ç­–ç•¥

```go
// è®¾ç½®ç¼“å­˜TTL
p.SetCacheTTL(2 * time.Hour)

// æ‰‹åŠ¨ç¼“å­˜æ›´æ–°
p.UpdateMainCache(cacheKey, results, ttl, true, keyword)
```

### 3. é”™è¯¯å¤„ç†

```go
func (p *MyPlugin) searchImpl(client *http.Client, keyword string, ext map[string]interface{}) ([]model.SearchResult, error) {
    // ç½‘ç»œé”™è¯¯å¤„ç†
    resp, err := client.Get(url)
    if err != nil {
        return nil, fmt.Errorf("[%s] ç½‘ç»œè¯·æ±‚å¤±è´¥: %w", p.Name(), err)
    }
    
    // HTTPçŠ¶æ€ç æ£€æŸ¥
    if resp.StatusCode != 200 {
        return nil, fmt.Errorf("[%s] HTTPé”™è¯¯: %d", p.Name(), resp.StatusCode)
    }
    
    // JSONè§£æé”™è¯¯ - æ¨èä½¿ç”¨é¡¹ç›®ç»Ÿä¸€çš„JSONå·¥å…·
    body, err := io.ReadAll(resp.Body)
    if err != nil {
        return nil, fmt.Errorf("[%s] è¯»å–å“åº”å¤±è´¥: %w", p.Name(), err)
    }
    
    var apiResp APIResponse
    if err := json.Unmarshal(body, &apiResp); err != nil {
        return nil, fmt.Errorf("[%s] JSONè§£æå¤±è´¥: %w", p.Name(), err)
    }
    
    // ä¸šåŠ¡é€»è¾‘é”™è¯¯
    if apiResp.Code != 0 {
        return nil, fmt.Errorf("[%s] APIé”™è¯¯: %s", p.Name(), apiResp.Message)
    }
    
    return results, nil
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. HTTPå®¢æˆ·ç«¯ä¼˜åŒ–

```go
// ä½¿ç”¨è¿æ¥æ± 
client := &http.Client{
    Timeout: 30 * time.Second,
    Transport: &http.Transport{
        MaxIdleConns:        100,
        MaxIdleConnsPerHost: 10,
        IdleConnTimeout:     90 * time.Second,
    },
}
```

### 2. å†…å­˜ä¼˜åŒ–

```go
// é¢„åˆ†é…åˆ‡ç‰‡å®¹é‡
results := make([]model.SearchResult, 0, expectedCount)

// åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡
defer func() {
    apiResp = APIResponse{}
}()
```

### 3. å¹¶å‘æ§åˆ¶

```go
// ä½¿ç”¨æ’ä»¶å†…ç½®çš„å·¥ä½œæ± ï¼Œé¿å…åˆ›å»ºè¿‡å¤šgoroutine
// BaseAsyncPlugin å·²ç»æä¾›äº†å·¥ä½œæ± ç®¡ç†
```

## æµ‹è¯•å’Œè°ƒè¯•

### 1. å•å…ƒæµ‹è¯•

```go
func TestMyPlugin_Search(t *testing.T) {
    plugin := &MyPlugin{
        BaseAsyncPlugin: plugin.NewBaseAsyncPlugin("test", 3),
    }
    
    results, err := plugin.Search("æµ‹è¯•å…³é”®è¯", nil)
    assert.NoError(t, err)
    assert.NotEmpty(t, results)
}
```

### 2. é›†æˆæµ‹è¯•

```bash
# ä½¿ç”¨APIæµ‹è¯•æ’ä»¶
curl "http://localhost:8888/api/search?kw=æµ‹è¯•&plugins=myplugin"
```

### 3. æ€§èƒ½æµ‹è¯•

```bash
# ä½¿ç”¨å‹åŠ›æµ‹è¯•è„šæœ¬
python3 stress_test.py
```

## éƒ¨ç½²å’Œé…ç½®

### 1. æ’ä»¶æ³¨å†Œ

ç¡®ä¿åœ¨ `init()` å‡½æ•°ä¸­æ³¨å†Œæ’ä»¶ï¼š

```go
func init() {
    p := &MyPlugin{
        BaseAsyncPlugin: plugin.NewBaseAsyncPlugin("myplugin", 3),
    }
    plugin.RegisterGlobalPlugin(p)
}
```

### 2. ç¯å¢ƒé…ç½®

```bash
# å¼‚æ­¥æ’ä»¶é…ç½®
export ASYNC_PLUGIN_ENABLED=true
export ASYNC_RESPONSE_TIMEOUT=4
export ASYNC_MAX_BACKGROUND_WORKERS=40
export ASYNC_MAX_BACKGROUND_TASKS=200
```

### 3. ç”Ÿäº§éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **èµ„æºé™åˆ¶**: æ ¹æ®æœåŠ¡å™¨é…ç½®è°ƒæ•´å·¥ä½œæ± å¤§å°
2. **ç›‘æ§å‘Šè­¦**: ç›‘æ§æ’ä»¶å“åº”æ—¶é—´å’Œé”™è¯¯ç‡
3. **æ—¥å¿—ç®¡ç†**: åˆç†è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
4. **ç¼“å­˜é…ç½®**: æ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡è°ƒæ•´ç¼“å­˜TTL

## ç°æœ‰æ’ä»¶å‚è€ƒ

### æ ‡å‡†ç½‘ç›˜æœç´¢æ’ä»¶
- **jikepan** - æ ‡å‡†ç½‘ç›˜æ’ä»¶ï¼Œå¯ç”¨Serviceå±‚è¿‡æ»¤
- **pan666** - æ ‡å‡†ç½‘ç›˜æ’ä»¶ï¼Œå¯ç”¨Serviceå±‚è¿‡æ»¤
- **hunhepan** - æ ‡å‡†ç½‘ç›˜æ’ä»¶ï¼Œå¯ç”¨Serviceå±‚è¿‡æ»¤
- **pansearch** - æ ‡å‡†ç½‘ç›˜æ’ä»¶ï¼Œå¯ç”¨Serviceå±‚è¿‡æ»¤
- **qupansou** - æ ‡å‡†ç½‘ç›˜æ’ä»¶ï¼Œå¯ç”¨Serviceå±‚è¿‡æ»¤
- **panta** - é«˜è´¨é‡ç½‘ç›˜æ’ä»¶ï¼Œå¯ç”¨Serviceå±‚è¿‡æ»¤

### ç‰¹æ®Šæœç´¢æ’ä»¶
- **thepiratebay** - ç£åŠ›æœç´¢æ’ä»¶ï¼Œè·³è¿‡Serviceå±‚è¿‡æ»¤ï¼Œæ”¯æŒtitle_enå‚æ•°ï¼Œæ ‡é¢˜æ ¼å¼åŒ–å¤„ç†

## æ’ä»¶å¼€å‘æœ€ä½³å®è·µ â­

### æ ¸å¿ƒåŸåˆ™

1. **å‘½åè§„èŒƒ**: æ’ä»¶åä½¿ç”¨å°å†™å­—æ¯å’Œæ•°å­—
2. **ä¼˜å…ˆçº§è®¾ç½®**: 1-2ä¸ºé«˜ä¼˜å…ˆçº§ï¼Œ3ä¸ºæ ‡å‡†ï¼Œ4-5ä¸ºä½ä¼˜å…ˆçº§
3. **å…³é”®è¯è¿‡æ»¤**: ä½¿ç”¨ `FilterResultsByKeyword` æé«˜ç»“æœç›¸å…³æ€§
4. **ç¼“å­˜å‹å¥½**: åˆç†è®¾ç½®ç¼“å­˜TTLï¼Œé¿å…é¢‘ç¹è¯·æ±‚
5. **èµ„æºæ¸…ç†**: åŠæ—¶å…³é—­è¿æ¥å’Œé‡Šæ”¾èµ„æº
6. **è¿‡æ»¤ç­–ç•¥**: æ ¹æ®æ’ä»¶ç±»å‹é€‰æ‹©åˆé€‚çš„Serviceå±‚è¿‡æ»¤ç­–ç•¥

### å¿…é¡»å®ç°çš„ä¼˜åŒ–ç‚¹

#### 1. Serviceå±‚è¿‡æ»¤ç­–ç•¥é€‰æ‹© â­ æ–°åŠŸèƒ½

```go
// âœ… ç£åŠ›æœç´¢æ’ä»¶ - è·³è¿‡Serviceå±‚è¿‡æ»¤
func NewMagnetSearchPlugin() *MagnetSearchPlugin {
    return &MagnetSearchPlugin{
        BaseAsyncPlugin: plugin.NewBaseAsyncPluginWithFilter("magnet", 4, true), // skipServiceFilter=true
    }
}

// âœ… æ ‡å‡†ç½‘ç›˜æ’ä»¶ - å¯ç”¨Serviceå±‚è¿‡æ»¤  
func NewPanSearchPlugin() *PanSearchPlugin {
    return &PanSearchPlugin{
        BaseAsyncPlugin: plugin.NewBaseAsyncPlugin("pansearch", 3), // é»˜è®¤skipServiceFilter=false
    }
}
```

**é€‰æ‹©æŒ‡å—**:
- **è·³è¿‡è¿‡æ»¤** (`true`): ç£åŠ›æœç´¢ã€è‹±æ–‡èµ„æºã€ç‰¹æ®Šæ ¼å¼æ ‡é¢˜ã€èšåˆæœç´¢
- **å¯ç”¨è¿‡æ»¤** (`false`): ç½‘ç›˜æœç´¢ã€ä¸­æ–‡èµ„æºã€APIæ¥å£ã€æ ‡å‡†æ ¼å¼æ ‡é¢˜

**æ³¨æ„äº‹é¡¹**:
- è·³è¿‡Serviceå±‚è¿‡æ»¤çš„æ’ä»¶**å¿…é¡»**åœ¨æ’ä»¶å†…éƒ¨è¿›è¡Œ`FilterResultsByKeyword`è¿‡æ»¤
- æ’ä»¶å±‚è¿‡æ»¤ä½¿ç”¨çš„å…³é”®è¯åº”ä¸å®é™…æœç´¢å…³é”®è¯ä¸€è‡´ï¼ˆæ”¯æŒ`title_en`ç­‰å‚æ•°ï¼‰
- æ ‡é¢˜æ ¼å¼åŒ–å¤„ç†åº”åœ¨è¿‡æ»¤ä¹‹å‰è¿›è¡Œï¼ˆå¦‚å°†`"."` æ›¿æ¢ä¸º`" "`ï¼‰

#### 2. SearchResultå­—æ®µè®¾ç½®è§„èŒƒ â­ é‡è¦

```go
// âœ… æ­£ç¡®çš„SearchResultè®¾ç½®
result := model.SearchResult{
    UniqueID: fmt.Sprintf("%s-%s", p.Name(), itemID),  // æ’ä»¶å-èµ„æºID
    Title:    title,                                   // èµ„æºæ ‡é¢˜
    Content:  description,                             // èµ„æºæè¿°
    Links:    downloadLinks,                           // ä¸‹è½½é“¾æ¥åˆ—è¡¨
    Tags:     tags,                                    // åˆ†ç±»æ ‡ç­¾
    Channel:  "",                                      // â­ é‡è¦ï¼šæ’ä»¶æœç´¢ç»“æœå¿…é¡»ä¸ºç©ºå­—ç¬¦ä¸²
    Datetime: time.Now(),                              // å‘å¸ƒæ—¶é—´
}

// âŒ é”™è¯¯çš„Channelè®¾ç½®
result.Channel = p.Name()  // ä¸è¦è®¾ç½®ä¸ºæ’ä»¶åï¼
```

**Channelå­—æ®µä½¿ç”¨è§„åˆ™**:
- **æ’ä»¶æœç´¢ç»“æœ**: `Channel` å¿…é¡»ä¸ºç©ºå­—ç¬¦ä¸² `""`
- **Telegramé¢‘é“**: `Channel` æ‰è®¾ç½®ä¸ºé¢‘é“åç§°
- **ç›®çš„**: åŒºåˆ†æœç´¢æ¥æºï¼Œä¾¿äºå‰ç«¯å±•ç¤ºå’Œåç«¯ç»Ÿè®¡

**Linkså­—æ®µå¤„ç†è§„åˆ™** â­ é‡è¦:
- **å¿…é¡»æœ‰é“¾æ¥**: ç³»ç»Ÿä¼šè‡ªåŠ¨è¿‡æ»¤æ‰ `Links` ä¸ºç©ºæˆ–é•¿åº¦ä¸º0çš„ç»“æœ
- **é“¾æ¥è´¨é‡**: ç¡®ä¿è¿”å›çš„é“¾æ¥éƒ½æ˜¯æœ‰æ•ˆçš„ç½‘ç›˜é“¾æ¥ï¼Œé¿å…è¿”å›æ— æ•ˆé“¾æ¥
- **é“¾æ¥éªŒè¯**: å»ºè®®ä½¿ç”¨ `isValidNetworkDriveURL()` å‡½æ•°é¢„å…ˆéªŒè¯é“¾æ¥æœ‰æ•ˆæ€§

#### 2. HTTPè¯·æ±‚æœ€ä½³å®è·µ â­ é‡è¦

```go
// âœ… æ­£ç¡®çš„è¯·æ±‚å®ç°
func (p *MyPlugin) makeRequest(url string, client *http.Client) (*http.Response, error) {
    // ä½¿ç”¨contextæ§åˆ¶è¶…æ—¶
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()
    
    // åˆ›å»ºè¯·æ±‚
    req, err := http.NewRequestWithContext(ctx, "GET", url, nil)
    if err != nil {
        return nil, err
    }
    
    // è®¾ç½®å®Œæ•´çš„è¯·æ±‚å¤´ï¼ˆé¿å…åçˆ¬è™«ï¼‰
    req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36")
    req.Header.Set("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8")
    req.Header.Set("Accept-Language", "zh-CN,zh;q=0.9,en;q=0.8")
    req.Header.Set("Connection", "keep-alive")
    req.Header.Set("Referer", "https://example.com/")
    
    // ä½¿ç”¨é‡è¯•æœºåˆ¶
    return p.doRequestWithRetry(req, client)
}

// âŒ é”™è¯¯çš„ç®€å•å®ç°
func (p *MyPlugin) badRequest(url string, client *http.Client) (*http.Response, error) {
    return client.Get(url) // æ²¡æœ‰è¶…æ—¶æ§åˆ¶ã€æ²¡æœ‰è¯·æ±‚å¤´ã€æ²¡æœ‰é‡è¯•
}
```

#### 2. å®ç°é«˜çº§æœç´¢æ¥å£ â­ æ¨è

```go
// âœ… æ¨èï¼šå®ç°ä¸¤ä¸ªæ–¹æ³•
func (p *MyPlugin) Search(keyword string, ext map[string]interface{}) ([]model.SearchResult, error) {
    result, err := p.SearchWithResult(keyword, ext)
    if err != nil {
        return nil, err
    }
    return result.Results, nil
}

func (p *MyPlugin) SearchWithResult(keyword string, ext map[string]interface{}) (model.PluginSearchResult, error) {
    return p.AsyncSearchWithResult(keyword, p.searchImpl, p.MainCacheKey, ext)
}
```

#### 3. é”™è¯¯å¤„ç†å¢å¼º â­ é‡è¦

```go
// âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
if resp.StatusCode != 200 {
    return nil, fmt.Errorf("[%s] è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : %d", p.Name(), resp.StatusCode)
}

// âœ… åŒ…è£…å¤–éƒ¨é”™è¯¯
if err := json.NewDecoder(resp.Body).Decode(&data); err != nil {
    return nil, fmt.Errorf("[%s] JSONè§£æå¤±è´¥: %w", p.Name(), err)
}
```

#### 4. é‡è¯•æœºåˆ¶æ¨¡æ¿ â­ å¤åˆ¶å¯ç”¨

```go
func (p *MyPlugin) doRequestWithRetry(req *http.Request, client *http.Client) (*http.Response, error) {
    maxRetries := 3
    var lastErr error
    
    for i := 0; i < maxRetries; i++ {
        if i > 0 {
            backoff := time.Duration(1<<uint(i-1)) * 200 * time.Millisecond
            time.Sleep(backoff)
        }
        
        reqClone := req.Clone(req.Context())
        resp, err := client.Do(reqClone)
        if err == nil && resp.StatusCode == 200 {
            return resp, nil
        }
        
        if resp != nil {
            resp.Body.Close()
        }
        lastErr = err
    }
    
    return nil, fmt.Errorf("é‡è¯• %d æ¬¡åä»ç„¶å¤±è´¥: %w", maxRetries, lastErr)
}
```

#### 5. è¯·æ±‚å¤´æ¨¡æ¿ â­ å¤åˆ¶å¯ç”¨

```go
// HTMLé¡µé¢è¯·æ±‚å¤´
req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36")
req.Header.Set("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8")
req.Header.Set("Accept-Language", "zh-CN,zh;q=0.9,en;q=0.8")
req.Header.Set("Connection", "keep-alive")
req.Header.Set("Upgrade-Insecure-Requests", "1")
req.Header.Set("Cache-Control", "max-age=0")
req.Header.Set("Referer", "https://example.com/")

// JSON APIè¯·æ±‚å¤´
req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36")
req.Header.Set("Accept", "application/json, text/plain, */*")
req.Header.Set("Accept-Language", "zh-CN,zh;q=0.9,en;q=0.8")
req.Header.Set("Connection", "keep-alive")
req.Header.Set("Content-Type", "application/json")
req.Header.Set("Referer", "https://example.com/")
```

### å¸¸è§é—®é¢˜é¿å…

1. **ä¸è¦ä½¿ç”¨ `client.Get(url)`** - ç¼ºå°‘è¶…æ—¶æ§åˆ¶å’Œè¯·æ±‚å¤´
2. **ä¸è¦å¿˜è®°è®¾ç½® User-Agent** - å¾ˆå¤šç½‘ç«™ä¼šé˜»æ­¢ç©ºUAè¯·æ±‚
3. **ä¸è¦å¿˜è®°é”™è¯¯ä¸Šä¸‹æ–‡** - ä½¿ç”¨ `fmt.Errorf("[%s] é”™è¯¯æè¿°: %w", p.Name(), err)`
4. **ä¸è¦å¿˜è®°å…³é—­å“åº”ä½“** - `defer resp.Body.Close()`
5. **ä¸è¦åœ¨å¾ªç¯ä¸­åˆ›å»ºå¤§é‡goroutine** - ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°
6. **Serviceå±‚è¿‡æ»¤å¸¸è§é—®é¢˜**:
   - âŒ **è·³è¿‡Serviceå±‚è¿‡æ»¤ä½†ä¸åœ¨æ’ä»¶å†…è¿‡æ»¤** - ä¼šè¿”å›å¤§é‡æ— å…³ç»“æœ
   - âŒ **ç£åŠ›æœç´¢æ’ä»¶ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°** - ä¼šè¢«Serviceå±‚è¯¯è¿‡æ»¤
   - âŒ **è¿‡æ»¤å…³é”®è¯ä¸ä¸€è‡´** - æ’ä»¶ç”¨`title_en`æœç´¢ä½†ç”¨åŸ`keyword`è¿‡æ»¤
   - âŒ **æ ‡é¢˜æ ¼å¼åŒ–åœ¨è¿‡æ»¤ä¹‹å** - æ ¼å¼åŒ–ä¸ä¼šæ”¹å–„è¿‡æ»¤æ•ˆæœ