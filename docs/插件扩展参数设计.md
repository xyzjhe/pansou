# 插件扩展参数设计与过滤逻辑重构

## 1. 背景与目标

### 1.1 背景

在PanSou搜索系统中，原有的设计将关键词过滤逻辑集中在主程序的`service/search_service.go`中实现。这种设计在处理自定义搜索参数（如英文标题搜索）时存在局限性，因为主程序的过滤逻辑只考虑原始关键词，而不考虑插件可能使用的其他搜索参数。

### 1.2 目标

1. 支持通过`ext`参数向插件传递自定义搜索参数

## 2. 设计方案

### 2.1 插件接口扩展

扩展`SearchPlugin`接口的`Search`方法，添加`ext`参数：

```go
type SearchPlugin interface {
    // Name 返回插件名称
    Name() string
    
    // Search 执行搜索并返回结果
    // ext参数用于传递额外的搜索参数，插件可以根据需要使用或忽略
    Search(keyword string, ext map[string]interface{}) ([]model.SearchResult, error)
    
    // Priority 返回插件优先级（可选，用于控制结果排序）
    Priority() int
}
```

### 2.2 插件实现扩展

#### 2.2.1 支持ext参数的插件示例

以`jikepan_ext`插件为例，实现支持`title_en`参数的搜索：

```go
// Search 执行搜索并返回结果
func (p *JikepanAsyncV2Plugin) doSearch(client *http.Client, keyword string, ext map[string]interface{}) ([]model.SearchResult, error) {    
    if ext != nil {
        if titleEn, ok := ext["title_en"].(string); ok && titleEn != "" {
            Keyword = titleEn
        }
    }
    
    // 构建请求
	reqBody := map[string]interface{}{
		"name":   keyword,
		"is_all": false,
	}
```

#### 2.2.2 不使用ext参数的插件

对于不需要使用ext参数的插件，可以简单地忽略该参数：

```go
// Search 执行搜索并返回结果
func (p *SomePlugin) Search(keyword string, ext map[string]interface{}) ([]model.SearchResult, error) {
    // 直接使用keyword进行搜索，忽略ext参数
    // ...
    
    return results, nil
}
```

### 2.3 API层支持

在`api/handler.go`中的`SearchHandler`函数中，添加对`ext`参数的处理：

```go
// 处理ext参数，JSON格式
var ext map[string]interface{}
extStr := c.Query("ext")
if extStr != "" && extStr != " " {
    if err := jsonutil.Unmarshal([]byte(extStr), &ext); err == nil {
        // 成功解析ext参数
    }
}

req = model.SearchRequest{
    Keyword:      keyword,
    Channels:     channels,
    Concurrency:  concurrency,
    ForceRefresh: forceRefresh,
    ResultType:   resultType,
    SourceType:   sourceType,
    Plugins:      plugins,
    Ext:          ext,
}
```

## 3. 实现步骤

### 3.1 插件改造

1. 修改所有插件的`Search`方法签名，添加`ext`参数

### 3.2 测试验证

1. 测试使用`ext`参数的搜索，验证自定义参数是否正确传递和使用

## 4. 注意事项

### 4.1 缓存键生成

为了确保缓存正常工作，缓存键生成应该只使用原始关键词，不包含`ext`参数。这样可以确保相同关键词的搜索可以共享缓存，即使`ext`参数不同。

## 5. 扩展性考虑

### 5.1 支持更多自定义参数

本设计使用通用的`map[string]interface{}`类型作为`ext`参数，可以灵活支持各种类型的自定义参数，如：

- `title_en`: 英文标题搜索
- `year`: 年份过滤
- `category`: 分类过滤
- `quality`: 质量过滤（如1080p、4K等）

### 5.2 插件特定参数

不同插件可以根据自身特点支持不同的自定义参数，主程序不需要了解这些参数的具体含义，只负责传递。